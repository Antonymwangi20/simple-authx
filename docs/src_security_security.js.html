<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>src/security/security.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-core_auth.AuthManager.html">AuthManager</a><ul class='methods'><li data-type='method'><a href="module-core_auth.AuthManager.html#generateTokens">generateTokens</a></li><li data-type='method'><a href="module-core_auth.AuthManager.html#login">login</a></li><li data-type='method'><a href="module-core_auth.AuthManager.html#loginWithIdentifier">loginWithIdentifier</a></li><li data-type='method'><a href="module-core_auth.AuthManager.html#refresh">refresh</a></li><li data-type='method'><a href="module-core_auth.AuthManager.html#register">register</a></li></ul></li><li><a href="module-core_auth-AuthManager.html">AuthManager</a></li><li><a href="module-security_audit.AuditLogger.html">AuditLogger</a></li><li><a href="module-security_audit-AuditLogger.html">AuditLogger</a></li><li><a href="module-security_security.SecurityManager.html">SecurityManager</a></li><li><a href="module-security_security-SecurityManager.html">SecurityManager</a></li></ul><h3>Modules</h3><ul><li><a href="module-core_auth.html">core/auth</a></li><li><a href="module-core_unified-api.html">core/unified-api</a><ul class='methods'><li data-type='method'><a href="module-core_unified-api.html#.createAuth">createAuth</a></li><li data-type='method'><a href="module-core_unified-api.html#~addMFARoutes">addMFARoutes</a></li><li data-type='method'><a href="module-core_unified-api.html#~addSessionRoutes">addSessionRoutes</a></li><li data-type='method'><a href="module-core_unified-api.html#~addSocialRoutes">addSocialRoutes</a></li><li data-type='method'><a href="module-core_unified-api.html#~createMemoryAdapter">createMemoryAdapter</a></li><li data-type='method'><a href="module-core_unified-api.html#~createProtectMiddleware">createProtectMiddleware</a></li><li data-type='method'><a href="module-core_unified-api.html#~createRouter">createRouter</a></li><li data-type='method'><a href="module-core_unified-api.html#~normalizeConfig">normalizeConfig</a></li><li data-type='method'><a href="module-core_unified-api.html#~setupAdapter">setupAdapter</a></li><li data-type='method'><a href="module-core_unified-api.html#~setupPlugins">setupPlugins</a></li></ul></li><li><a href="module-security_audit.html">security/audit</a></li><li><a href="module-security_security.html">security/security</a></li><li><a href="module-simple-authx.html">simple-authx</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getAuth">getAuth</a></li><li><a href="global.html#getDefaultConfig">getDefaultConfig</a></li><li><a href="global.html#hasherName">hasherName</a></li><li><a href="global.html#initializeAuth">initializeAuth</a></li><li><a href="global.html#isAuthInitialized">isAuthInitialized</a></li><li><a href="global.html#protect">protect</a></li><li><a href="global.html#resetAuth">resetAuth</a></li><li><a href="global.html#verifyPassword">verifyPassword</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">src/security/security.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Security manager for rate limiting, login attempt tracking, and IP reputation
 * @module security/security
 */

import rateLimit from 'express-rate-limit';
import RedisStore from 'rate-limit-redis';
import ms from 'ms';

/**
 * Security manager for handling rate limiting, login attempts, and IP reputation
 *
 * @class SecurityManager
 * @example
 * const security = new SecurityManager({
 *   redis: redisClient,
 *   maxFailedAttempts: 5,
 *   ipBlockDuration: '24h',
 *   attemptWindow: '15m'
 * });
 */
export class SecurityManager {
  /**
   * Creates a new SecurityManager instance
   * @param {Object} config - Configuration object
   * @param {Object} [config.redis] - Redis client for distributed rate limiting
   * @param {number} [config.maxFailedAttempts=5] - Maximum failed login attempts before blocking
   * @param {string} [config.ipBlockDuration='24h'] - How long to block an IP after too many failures
   * @param {string} [config.attemptWindow='15m'] - Time window for counting failed attempts
   */
  constructor(config = {}) {
    this.redis = config.redis;
    this.ipBlockDuration = ms(/** @type {any} */ (config.ipBlockDuration) || '24h');
    this.maxFailedAttempts = config.maxFailedAttempts || 5;
    this.attemptWindow = ms(/** @type {any} */ (config.attemptWindow) || '15m');
  }

  createRateLimiter(options = {}) {
    const windowMs = Number(ms(options.window || '15m'));
    const config = {
      windowMs,
      max: options.max || 100,
      standardHeaders: true,
      legacyHeaders: false,
      skipSuccessfulRequests: options.skipSuccessful || false,
      handler: (req, res) => {
        res.status(429).json({
          error: 'Too many requests',
          retryAfter: Math.ceil(windowMs / 1000),
          code: 'RATE_LIMIT_EXCEEDED',
        });
      },
    };

    if (this.redis) {
      config.store = new RedisStore({
        sendCommand: (...args) => this.redis.sendCommand(args),
        prefix: options.prefix || 'rl:',
      });
    }

    return rateLimit(config);
  }

  async trackLoginAttempt(username, ip, success) {
    if (!this.redis) {
      return undefined;
    }

    const now = Date.now();
    const userKey = `auth:attempts:user:${username}`;
    const ipKey = `auth:attempts:ip:${ip}`;

    if (success) {
      // Clear failed attempts on success
      await this.redis.del(userKey);
      await this.redis.del(ipKey);
      return { userBlocked: false, ipBlocked: false };
    }

    // Track failed attempts
    const multi = this.redis.multi();

    // Add attempt with timestamp
    multi.zadd(userKey, now, now.toString());
    multi.zadd(ipKey, now, now.toString());

    // Remove old attempts outside window
    const cutoff = now - Number(this.attemptWindow);
    multi.zremrangebyscore(userKey, 0, cutoff);
    multi.zremrangebyscore(ipKey, 0, cutoff);

    // Set expiry
    multi.expire(userKey, Math.ceil(Number(this.attemptWindow) / 1000));
    multi.expire(ipKey, Math.ceil(Number(this.ipBlockDuration) / 1000));

    const [userAttempts, ipAttempts] = await multi.exec();

    return {
      userBlocked: userAttempts >= this.maxFailedAttempts,
      ipBlocked: ipAttempts >= this.maxFailedAttempts * 2, // IP gets double the attempts
    };
  }

  async isBlocked(username, ip) {
    if (!this.redis) return false;

    const userKey = `auth:attempts:user:${username}`;
    const ipKey = `auth:attempts:ip:${ip}`;
    const now = Date.now();
    const cutoff = now - Number(this.attemptWindow);

    const [userAttempts, ipAttempts] = await Promise.all([
      this.redis.zcount(userKey, cutoff, '+inf'),
      this.redis.zcount(ipKey, cutoff, '+inf'),
    ]);

    return {
      userBlocked: userAttempts >= this.maxFailedAttempts,
      ipBlocked: ipAttempts >= this.maxFailedAttempts * 2,
      remainingAttempts: Math.min(
        this.maxFailedAttempts - userAttempts,
        this.maxFailedAttempts * 2 - ipAttempts
      ),
    };
  }

  // IP Intelligence
  async trackIPActivity(ip) {
    if (!this.redis) return null;

    const key = `auth:ip:${ip}`;
    const now = Date.now();

    await this.redis.zadd(key, now, now.toString());

    // Get activity count in last hour
    const hourAgo = now - ms('1h');
    const recentActivity = await this.redis.zcount(key, hourAgo, '+inf');

    // Cleanup old data
    await this.redis.zremrangebyscore(key, 0, hourAgo);

    return recentActivity;
  }

  async getIPReputation(ip) {
    if (!this.redis) return 'unknown';

    const blockKey = `auth:attempts:ip:${ip}`;
    const activityKey = `auth:ip:${ip}`;
    const now = Date.now();

    const [failedAttempts, recentActivity] = await Promise.all([
      this.redis.zcount(blockKey, now - Number(this.attemptWindow), '+inf'),
      this.redis.zcount(activityKey, now - Number(ms('24h')), '+inf'),
    ]);

    if (failedAttempts >= this.maxFailedAttempts * 2) return 'blocked';
    if (failedAttempts >= this.maxFailedAttempts) return 'suspicious';
    if (recentActivity > 1000) return 'high_activity';
    if (recentActivity > 100) return 'medium_activity';
    return 'normal';
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Mon Nov 10 2025 22:45:53 GMT+0300 (East Africa Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
